# prek Configuration: A fast pre-commit hook manager written in Rust.
# This file defines the hooks that run before each commit to ensure code quality and security.

# Stop execution immediately if any hook fails.
fail_fast: true

repos:
  # Built-in hooks provided natively by prek.
  # These are optimized for speed as they are implemented directly in the prek framework.
  - repo: builtin
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-added-large-files
      - id: fix-byte-order-marker
      - id: check-json
      - id: check-toml
      - id: check-yaml
      - id: check-xml
      - id: mixed-line-ending
      - id: check-symlinks
      - id: check-merge-conflict
      - id: detect-private-key
      - id: check-case-conflict
      # - id: no-commit-to-branch # Disabled: Direct commits to main are standard in this dotfiles repo
      - id: check-executables-have-shebangs

  # Local hooks targeting system-installed tools.
  # These hooks run specific binaries available in the environment (e.g., via shell.nix).
  - repo: local
    hooks:
      # Semantic commit message linter.
      - id: commitlint
        name: commitlint
        language: system
        entry: commitlint --edit
        stages: [commit-msg]

      # Unified formatter pass using treefmt.
      # Fixes a 10s delay:
      # - Conflict: Prek captures output via pipes, but TERM indicates a smart TTY.
      # - Bug: treefmt hangs waiting for TTY initialization/response.
      # - Fix: TERM=dumb forces basic mode, skipping the timeout-prone TTY check.
      - id: treefmt
        name: treefmt
        language: system
        entry: env TERM=dumb treefmt
        require_serial: true

      # GitHub Actions workflow linter.
      - id: actionlint
        name: actionlint
        language: system
        entry: actionlint
        files: ^\.github/workflows/

      # Nix linter and anti-pattern finder.
      - id: statix
        name: statix
        language: system
        entry: statix fix
        files: \.nix$
        pass_filenames: false

      # Ruby linter and formatter.
      - id: rubocop
        name: rubocop
        language: system
        entry: rubocop
        files: \.rb$
        require_serial: true

      # Fast secret scanning for generic high-entropy strings.
      - id: ripsecrets
        name: ripsecrets
        language: system
        entry: ripsecrets

      # Comprehensive secret scanning with service-specific rules.
      # Optimized to only scan staged changes for performance.
      - id: gitleaks
        name: gitleaks
        language: system
        entry: gitleaks protect --staged --verbose --redact
        pass_filenames: false
