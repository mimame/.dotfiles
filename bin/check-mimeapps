#!/usr/bin/env fish

# check-mimeapps: A high-performance script to verify XDG Mime Application consistency.
# Optimized for speed using 'gio mime' and native Fish background jobs.

# 1. Platform Detection & Tool Verification
if not set -q IS_LINUX
    set -gx IS_LINUX false
    if test (uname -s) = Linux; set -gx IS_LINUX true; end
end

if not $IS_LINUX
    echo "Check skipped: This script is only intended for Linux systems."
    exit 0
end

set -l tool
if command -q gio
    set tool gio
else if command -q xdg-mime
    set tool xdg-mime
else
    echo "Error: Neither 'gio' nor 'xdg-mime' found. Please install xdg-utils or glib2." >&2
    exit 1
end

# 2. Path Setup
set -l script_path (readlink -f (status --current-filename))
set -l dotfiles_root (dirname (dirname "$script_path"))
set -l mimeapps_file "$dotfiles_root/mimeapps/mimeapps.list"

if not test -f "$mimeapps_file"
    echo "Error: mimeapps.list not found at $mimeapps_file" >&2
    exit 1
end

# 3. Extract associations
set -l associations (awk '/^\[Default Applications\]/{f=1;next} /^\[/{f=0} f && /=/ && !/^\s*#/' "$mimeapps_file")
set -l total (count $associations)

if test $total -eq 0
    echo "No associations found in $mimeapps_file."
    exit 0
end

echo "üîç Checking $total mime associations in parallel (using $tool)..."

# 4. Execute parallel checks using Fish internal backgrounding
# This is much faster than xargs -P because it avoids spawning 341 shell processes.
set -l tmpdir (mktemp -d)

for association in $associations
    begin
        # Parse association (no forks)
        set -l parts (string split -m 1 "=" -- $association)
        set -l mime (string trim $parts[1])
        set -l expected (string replace -r ';$' '' $parts[2] | string trim)

        set -l actual
        if test "$tool" = gio
            set actual (gio mime "$mime" 2>/dev/null | awk '/Default application/ {print $NF}')
        else
            set actual (xdg-mime query default "$mime" 2>/dev/null)
        end

        if test -n "$actual"; and test "$expected" != "$actual"
            set -l mime_file (string replace -a "/" "_" -- $mime)
            echo "$expected|$actual" > "$tmpdir/$mime_file"
        end
    end &
end

# Wait for all background jobs to finish
wait

set -l failure_files (ls -1 $tmpdir 2>/dev/null)
set -l mismatches (count $failure_files)

# 5. Report Results
if test $mismatches -eq 0
    set_color -o green
    echo "‚úÖ Success: All $total associations are consistent."
    set_color normal
    set -l exit_code 0
else
    echo ""
    set_color -o red
    echo "‚ùå Failure: Found $mismatches mismatches out of $total associations."
    set_color normal

    # Detailed report for failures (sorted by mime type)
    for f in (printf "%s\n" $failure_files | sort)
        set -l mime (string replace -a "_" "/" -- $f)
        set -l res (cat "$tmpdir/$f")
        set -l res_parts (string split "|" -- $res)
        echo "  - $mime:"
        echo "      Expected: $res_parts[1]"
        echo "      Actual:   $res_parts[2]"
    end

    echo ""
    echo "Tip: Run 'update-mimeapps.rb' to regenerate associations."
    set -l exit_code 1
end

rm -rf "$tmpdir"
exit $exit_code
