#!/usr/bin/env fish

# ------------------------------------------------------------------------------
#
#  check-mimeapps: A script to verify XDG Mime Application consistency.
#
#  This script checks for inconsistencies between the default applications
#  configured in `~/.config/mimeapps.list` and the associations reported by
#  the `xdg-mime` utility. It is designed to be run as a pre-commit hook or
#  manually to ensure that the system's mime type database is in sync with
#  the configuration file.
#
#  How it works:
#  1. It reads all `mime-type=application.desktop` entries from the
#     `[Default Applications]` section of `~/.config/mimeapps.list`.
#  2. For each mime type, it queries the system's default application using
#     `xdg-mime query default <mime-type>`.
#  3. It compares the application from the file with the one from the system.
#  4. It reports any mismatches found.
#
#  Exit Codes:
#    - 0: All associations are consistent.
#    - 1: Mismatches were found or an error occurred.
#
# ------------------------------------------------------------------------------

# Path to the user's mimeapps.list configuration file.
set -l script_path (readlink -f (status --current-filename))
set -l script_dir (dirname "$script_path")
set -l dotfiles_root (dirname "$script_dir")
set -l mimeapps_file "$dotfiles_root/mimeapps/mimeapps.list"
set -l exit_code 0

# 1. Early exits for platform and missing tools
if not $IS_LINUX
    echo "Check skipped: This script is only intended for Linux systems."
    exit 0
end

if not command -q xdg-mime
    echo "Error: xdg-mime not found. Please install it to check associations." >&2
    exit 1
end

if not test -f "$mimeapps_file"
    echo "Error: mimeapps.list not found at $mimeapps_file" >&2
    exit 1
end

# 2. Extract associations using robust awk parsing
set -l associations (awk '/^\[Default Applications\]/{f=1;next} /^\[/{f=0} f' "$mimeapps_file" | grep '=' | grep -v '^\s*#')

if test -z "$associations"
    echo "No mime type associations found in $mimeapps_file under [Default Applications] to check."
    exit 0
end

echo "üîç Checking mime type associations..."

set -l total (count $associations)
set -l count 0
set -l mismatches 0

# 3. Iterate over each association line with colorized output
for association in $associations
    set count (math $count + 1)
    # Split the line into mime type and expected application.
    set -l mime_type (echo "$association" | cut -d'=' -f1 | string trim)
    set -l expected_app (echo "$association" | cut -d'=' -f2 | sed 's/;//' | string trim)

    if test -z "$mime_type" -o -z "$expected_app"
        continue
    end

    # Get the actual default application from the system's mime database.
    set -l actual_app (xdg-mime query default "$mime_type" 2>/dev/null)

    # Compare the expected app from the file with the actual app from the system.
    if test "$expected_app" != "$actual_app"
        set mismatches (math $mismatches + 1)
        set_color red
        echo "  Mismatch ($count/$total): $mime_type"
        set_color normal
        echo "    Expected: $expected_app"
        echo "    Actual:   $actual_app"
        set exit_code 1
    else if status is-interactive
        # Only show OK status in interactive shells to keep CI logs cleaner
        set_color green
        echo -n "  ‚úî "
        set_color normal
        echo "$mime_type -> $actual_app"
    end
end

# 4. Final summary report
if test $exit_code -eq 0
    set_color -o green
    echo "‚úÖ Success: All $total checked associations are consistent."
    set_color normal
else
    set_color -o red
    echo "‚ùå Failure: Found $mismatches mismatches out of $total associations."
    set_color normal
    echo "Tip: Run 'update-mimeapps.rb' to regenerate the associations file."
end

exit $exit_code
