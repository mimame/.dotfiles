#!/usr/bin/env ruby
# frozen_string_literal: true

# update-mimeapps.rb
#
# This script generates a `~/.config/mimeapps.list` file based on a user-defined
# set of defaults and a system-wide scan of available applications.
#
# It ensures the user's preferred defaults are always enforced, preventing them
# from being overwritten by system updates or other applications.
#
# Features:
# - Reads preferred defaults from a simple YAML config file.
# - Supports wildcards (e.g., "image/*") for broad category defaults.
# - Supports specific overrides for fine-grained control.
# - Scans the system for all available .desktop files and their mimetypes.
# - Self-cleans the defaults.yaml file by removing entries for uninstalled apps.
# - Generates a clean `mimeapps.list` with [Default Applications] and
#   [Added Associations] sections.

require 'set'
require 'find'
require 'yaml'

# --- Configuration ---

# The user's source of truth for default applications.
DEFAULTS_PATH = File.expand_path('../mimeapps/defaults.yaml', __dir__)

# The final output file that desktop environments will use.
MIMEAPPS_OUTPUT_PATH = File.expand_path('~/.config/mimeapps.list')

# We only search the Nix store to ensure all applications are declaratively managed.
SEARCH_PATHS = [
  '/nix/store'
].freeze

# --- Main Class ---

class MimeappsGenerator
  def initialize
    @mimetype_to_apps = Hash.new { |h, k| h[k] = Set.new }
    @available_apps = Set.new
    @exact_defaults = {}
    @wildcard_defaults = {}
    @final_defaults = {}
  end

  def run
    puts 'üöÄ Starting mimeapps.list generation...'

    scan_desktop_files
    clean_user_defaults
    load_user_defaults
    resolve_defaults
    write_output

    puts "‚úÖ Successfully generated #{MIMEAPPS_OUTPUT_PATH}"
  end

  private

  def scan_desktop_files
    puts 'üîç Scanning for .desktop files in the Nix store...'
    SEARCH_PATHS.each do |search_path|
      next unless Dir.exist?(search_path)

      Find.find(search_path) do |path|
        # Ensure we only process actual files, not directories that end in .desktop
        next unless path.end_with?('.desktop') && File.file?(path)

        content = File.read(path)
        next if content.include?('NoDisplay=true')

        mimetypes_line = content.lines.find { |l| l.start_with?('MimeType=') }
        next unless mimetypes_line

        app_name = File.basename(path)
        @available_apps.add(app_name)
        mimetypes = mimetypes_line.split('=').last.strip.split(';').map(&:strip).reject(&:empty?)

        mimetypes.each do |mime|
          @mimetype_to_apps[mime].add(app_name)
        end
      end
    end
    puts "   Found #{@mimetype_to_apps.keys.length} unique mimetypes from #{@available_apps.length} applications."
  end

  def clean_user_defaults
    return unless File.exist?(DEFAULTS_PATH)

    puts 'üßπ Cleaning defaults.yaml of uninstalled applications...'
    config = YAML.load_file(DEFAULTS_PATH)
    defaults = config['Default Applications'] || {}

    original_count = defaults.size
    cleaned_defaults = defaults.select { |_mime, app| @available_apps.include?(app) }
    removed_count = original_count - cleaned_defaults.size

    return unless removed_count > 0

    puts "   Removed #{removed_count} obsolete entries."
    config['Default Applications'] = cleaned_defaults
    File.write(DEFAULTS_PATH, config.to_yaml)
  end

  def load_user_defaults
    return unless File.exist?(DEFAULTS_PATH)

    puts "‚öôÔ∏è  Loading user defaults from #{DEFAULTS_PATH}..."
    defaults = YAML.load_file(DEFAULTS_PATH)['Default Applications'] || {}

    defaults.each do |key, value|
      if key.include?('*')
        @wildcard_defaults[key] = value
      else
        @exact_defaults[key] = value
      end
    end
  end

  def resolve_defaults
    puts 'üß† Resolving final default applications...'
    # 1. Apply wildcard defaults first
    @mimetype_to_apps.keys.each do |mime|
      @wildcard_defaults.each do |pattern, app|
        @final_defaults[mime] = app if File.fnmatch(pattern, mime)
      end
    end

    # 2. Apply exact defaults, which will override any wildcard matches
    @final_defaults.merge!(@exact_defaults)
  end

  def write_output
    puts "‚úçÔ∏è  Generating new #{File.basename(MIMEAPPS_OUTPUT_PATH)}..."
    output = []
    output << "# This file is auto-generated by the update-mimeapps.rb script."
    output << "# Do not edit directly. Your defaults are managed in:"
    output << "# #{DEFAULTS_PATH}\n\n"

    output << "[Default Applications]"
    @final_defaults.sort.to_h.each do |mime, app|
      output << "#{mime}=#{app}"
    end
    output << "\n"

    output << "[Added Associations]"
    @mimetype_to_apps.sort.to_h.each do |mime, apps|
      output << "#{mime}=#{apps.to_a.sort.join(';')};"
    end

    File.write(MIMEAPPS_OUTPUT_PATH, output.join("\n") + "\n")
  end
end

# --- Run Script ---
MimeappsGenerator.new.run
